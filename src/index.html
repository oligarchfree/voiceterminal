<!doctype html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Hubitat POC (Dropdown + Intent Router)</title>
	<style>
		body { font-family: system-ui, sans-serif; padding: 16px; max-width: 820px; }
		label { display:block; margin-top: 12px; font-weight: 600; }
		input, button, select { font-size: 16px; padding: 10px; margin: 6px 0; width: 100%; }
		.row { display:flex; gap:12px; }
		.row > * { flex:1; }
		pre { background: #f5f5f5; padding: 10px; border-radius: 8px; overflow: auto; }
		.muted { opacity: 0.8; font-size: 13px; }
		.pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eee; margin-left:8px; }
	</style>
</head>
<body>
	<h2>Hubitat POC (Pure JS) ‚Äî Dropdown Device Selector</h2>
	<div class="muted">
		Proof-of-concept using a local Node proxy to avoid CORS.
		(Hubitat token stays on the server.)
	</div>

	<div class="muted" style="margin-top:8px;">
		Intent module:
		<span id="intentStatus" class="pill">loading‚Ä¶</span>
	</div>

	<label>Device</label>
	<div class="row">
		<select id="deviceSelect"></select>
		<button id="syncBtn">Sync Devices</button>
	</div>

	<div class="row">
		<button id="onBtn">Turn ON</button>
		<button id="offBtn">Turn OFF</button>
	</div>

	<label>Command text (pretend this came from ASR)</label>
	<input id="cmd" placeholder='e.g. "turn it on" or "turn it off"' />
	<button id="runBtn">Route + Execute (uses selected device)</button>

	<pre id="log"></pre>

	<hr style="margin: 40px 0; border: 2px solid #ccc;">

	<h2>STT</h2>
	<div class="muted">
		Wake word: <b>Zentra</b>. Say "Zentra" then command, or "Zentra turn it on".
	</div>

	<div class="row">
		<button id="micButton">Start Microphone</button>
		<button id="clearVoiceLog">Clear Voice Log</button>
	</div>

	<div id="sttStatus" class="muted" style="margin-top:10px;">Loading STT‚Ä¶</div>
	<div id="transcribeDuration" class="muted"></div>
	<div id="voiceLog" style="margin-top:12px;"></div>

<script>
	// ===================== UI helpers =====================
	const logEl = document.getElementById("log");
	const deviceSelect = document.getElementById("deviceSelect");
	const cmdInput = document.getElementById("cmd");
	const intentStatus = document.getElementById("intentStatus");

	const log = (...args) => { logEl.textContent += args.join(" ") + "\n"; };
	const clearLog = () => { logEl.textContent = ""; };

	const voiceLog = document.getElementById("voiceLog");
	const sttStatus = document.getElementById("sttStatus");
	const transcribeDuration = document.getElementById("transcribeDuration");

	function appendVoiceLine(html) {
		const div = document.createElement("div");
		div.innerHTML = html;
		voiceLog.appendChild(div);
	}

	function intentCtx() {
		return {
			hubitat: window.Hubitat,
			getSelectedDeviceId: () => window.Hubitat.getSelectedDeviceId(),
		};
	}

	// ‚úÖ The ONE function STT calls.
	window.onVoiceCommand = async function onVoiceCommand(text, meta = {}) {
		appendVoiceLine(`<div><b>üéôÔ∏è</b> ${text} <span style="opacity:.65">(source: ${meta.source || "?"})</span></div>`);
		if (meta.transcribeSeconds != null) {
			transcribeDuration.textContent = `Transcription: ${meta.transcribeSeconds}s`;
		}

		clearLog();
		try {
			// DEBUG: prove Intent is loaded and what it routes to
			if (!window.Intent) {
				log("‚ùå window.Intent is missing. intentProcessor.js did not load.");
				return;
			}
			log("Intent module:", window.Intent.VERSION || "(no version)");

			const routed = window.Intent.route(text);
			log("Selected device:", window.Hubitat.getSelectedDeviceId());
			log("Voice:", JSON.stringify(text));
			log("Route result:", routed ? `‚úÖ ${routed.intent}` : "‚ùå null (no match)");

			if (!routed) return;
			await window.Intent.execute(routed, intentCtx());
			log("‚úÖ Executed:", routed.intent);
		} catch (e) {
			log("Error:", e.message);
		}
	};

	window.onSTTStatus = function onSTTStatus(msg) {
		sttStatus.textContent = msg;
	};

	// ===================== UI wiring =====================
	document.getElementById("clearVoiceLog").onclick = () => { voiceLog.innerHTML = ""; };

	document.getElementById("syncBtn").onclick = async () => {
		clearLog();
		try {
			log("Syncing devices from Maker API (via local proxy)...");
			const registry = await window.Hubitat.syncDevices();
			log("Registry built. Supported devices:", Object.keys(registry.byId).length);
			window.Hubitat.populateDeviceDropdown(deviceSelect);
			log("Done.");
		} catch (e) {
			log("Error:", e.message);
		}
	};

	document.getElementById("onBtn").onclick = async () => {
		clearLog();
		try {
			log("Selected device:", window.Hubitat.getSelectedDeviceId());
			await window.Hubitat.sendCommand(window.Hubitat.getSelectedDeviceId(), "on");
			log("Done.");
		} catch (e) {
			log("Error:", e.message);
		}
	};

	document.getElementById("offBtn").onclick = async () => {
		clearLog();
		try {
			log("Selected device:", window.Hubitat.getSelectedDeviceId());
			await window.Hubitat.sendCommand(window.Hubitat.getSelectedDeviceId(), "off");
			log("Done.");
		} catch (e) {
			log("Error:", e.message);
		}
	};

	document.getElementById("runBtn").onclick = async () => {
		clearLog();
		try {
			const raw = cmdInput.value;

			if (!window.Intent) {
				log("‚ùå window.Intent is missing. intentProcessor.js did not load.");
				return;
			}

			const routed = window.Intent.route(raw);
			log("Intent module:", window.Intent.VERSION || "(no version)");
			log("Selected device:", window.Hubitat.getSelectedDeviceId());
			log("ASR:", JSON.stringify(raw));
			log("Route result:", routed ? `‚úÖ ${routed.intent}` : "‚ùå null (no match)");

			if (!routed) return;
			await window.Intent.execute(routed, intentCtx());
			log("‚úÖ Executed:", routed.intent);
		} catch (e) {
			log("Error:", e.message);
		}
	};
</script>

<!-- Load order matters -->
<script src="./hubitat.js"></script>
<script src="./intentProcessor.js"></script>
<script src="./tokenizer.js"></script>
<script src="./stt.js"></script>

<script>
	// Boot
	window.addEventListener("load", async () => {
		// Sync devices on startup to populate tokenizer
		try {
			await window.Hubitat?.syncDevices();
			window.Hubitat?.populateDeviceDropdown(deviceSelect);
		} catch (e) {
			console.error("Failed to sync devices on startup:", e);
		}

		// Visual proof intentProcessor.js loaded
		if (window.Intent) {
			intentStatus.textContent = window.Intent.VERSION || "loaded";
		} else {
			intentStatus.textContent = "‚ùå NOT LOADED";
		}


	});

	document.getElementById("micButton").onclick = async () => {
		if (!window.STT || !window.STT.toggleMic) {
			window.onSTTStatus?.("STT not ready yet‚Ä¶");
			return;
		}
		await window.STT.toggleMic();
	};


	
</script>
<p>chrome://settings/content/microphone</p>
<textarea id="chatLog" style="width: 80%;height:500px">CHAT LOG</textarea>
</body>
</html>
